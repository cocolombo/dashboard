{% load static %}
<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Perso</title>

    <script src="{% static 'js/tailwind.js' %}"></script>
    <script src="{% static 'js/htmx.js' %}"></script>
    <script src="{% static 'js/sortable.js' %}"></script>

    <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            gray: {
                                900: '#111827',
                                800: '#1f2937',
                                700: '#374151',
                            }
                        }
                    }
                }
            }
    </script>

    <style>
        #context-menu { display: none; position: absolute; z-index: 50; }
        .sortable-ghost { opacity: 0.4; background-color: #4B5563; }

        /* --- MODE ZEN --- */
        body.zen-mode #main-nav { display: none !important; }
        body.zen-mode #search-container { display: none !important; }
        body.zen-mode .main-content { padding-top: 2rem !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen select-none"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
<!-- =================================== -->
<!-- NAVIGATION PRINCIPALE (Pages)      -->
<!-- =================================== -->
<nav id="main-nav" class="flex items-center space-x-2 p-3 bg-black border-b border-gray-800 overflow-x-auto">
    <div class="font-bold text-xl mr-4 text-white">‚â° Pages</div>

    {% for page in pages %}
            <a href="{% url 'index' page.slug %}"
               data-id="{{ page.id }}"
               class="px-4 py-2 rounded transition-colors duration-200 whitespace-nowrap cursor-move
               {% if page == active_page %}bg-blue-600 text-white font-bold shadow-md{% else %}bg-gray-800 hover:bg-gray-700 text-gray-300{% endif %}">
                {{ page.name }}
            </a>
        {% endfor %}

    <button onclick="toggleModal('modal-add-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-green-600 text-gray-400 hover:text-white font-bold transition-colors"
            title="Nouvelle page">
        +
    </button>

    {% if active_page %}
    <div class="h-6 w-px bg-gray-700 mx-2"></div>

    <button onclick="toggleModal('modal-rename-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-yellow-600 text-gray-400 hover:text-white transition-colors"
            title="Renommer la page active">
        ‚úé
    </button>

    <button onclick="toggleModal('modal-delete-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-red-600 text-gray-400 hover:text-white transition-colors"
            title="Supprimer la page active">
        üóë
    </button>
    {% endif %}
</nav>

<!-- =================================== -->
<!-- BARRE DE RECHERCHE + BOUTON AJOUT  -->
<!-- =================================== -->
<div id="search-container" class="flex justify-center items-center py-8 px-4 gap-4">
    <form action="https://www.google.com/search" method="GET" target="_blank"
          class="w-full max-w-2xl relative group">
        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>
        <input type="text" name="q" placeholder="Rechercher sur le web..." autofocus
               class="w-full bg-gray-800 text-white text-lg border border-gray-700 rounded-full py-3 pl-12 pr-4 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all placeholder-gray-500">
        <div class="absolute inset-0 rounded-full bg-blue-500 opacity-0 group-focus-within:opacity-20 blur-md transition-opacity -z-10"></div>
    </form>

    {% if active_page %}
    <button onclick="toggleModal('modal-add-widget')"
            class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-full shadow-lg flex items-center font-bold transition-colors whitespace-nowrap"
            title="Ajouter une cat√©gorie √† cette page">
        <span class="text-xl mr-2 leading-none">+</span> Cat√©gorie
    </button>
    {% endif %}
</div>

<!-- =================================== -->
<!-- CONTENU PRINCIPAL (Grille widgets) -->
<!-- =================================== -->
<div class="p-6 main-content">
    {% if active_page %}

        <!-- Grille responsive des widgets -->
        <div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            {% if active_page.slug == 'infos' %}

            <!-- Widget M√©t√©o (Open-Meteo) -->
            <div class="col-span-1 md:col-span-2 bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 h-48 flex flex-col justify-between relative overflow-hidden">
                <!-- Contenu m√©t√©o actuel + pr√©visions -->
                <div class="flex justify-between items-start z-10">
                    <div>
                        <h3 class="font-bold text-white text-xl">M√©t√©o</h3>
                        <p class="text-sm text-gray-400 uppercase tracking-wider mt-1">Montr√©al, QC</p>
                    </div>
                    <div class="text-right">
                        <div id="current-temp" class="text-4xl font-bold text-white">--¬∞</div>
                        <div id="current-desc" class="text-xs text-gray-400 capitalize">Chargement...</div>
                    </div>
                </div>

                <div id="forecast-grid" class="grid grid-cols-3 gap-2 mt-4 z-10">
                    <!-- Pr√©visions charg√©es dynamiquement -->
                    <div class="text-center animate-pulse">
                        <div class="h-8 w-8 bg-gray-700 rounded-full mx-auto mb-2"></div>
                        <div class="h-2 w-10 bg-gray-700 rounded mx-auto"></div>
                    </div>
                    <div class="text-center animate-pulse delay-75">
                        <div class="h-8 w-8 bg-gray-700 rounded-full mx-auto mb-2"></div>
                        <div class="h-2 w-10 bg-gray-700 rounded mx-auto"></div>
                    </div>
                    <div class="text-center animate-pulse delay-150">
                        <div class="h-8 w-8 bg-gray-700 rounded-full mx-auto mb-2"></div>
                        <div class="h-2 w-10 bg-gray-700 rounded mx-auto"></div>
                    </div>
                </div>

                <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20"></div>
                <div class="absolute -left-10 -top-10 w-40 h-40 bg-orange-500 rounded-full mix-blend-multiply filter blur-3xl opacity-10"></div>
            </div>

            <!-- Widget Horloge & Date -->
            <div class="col-span-1 md:col-span-2 bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-700 h-48 flex flex-col justify-center items-center">
                <h3 class="font-bold text-orange-400 w-full text-left mb-2">Heure Locale</h3>
                <div id="clock-display" class="text-4xl font-mono text-blue-400 font-bold tracking-wider">--:--:--</div>
                <div id="date-display" class="text-gray-400 text-lg mt-2 capitalize">Chargement...</div>
            </div>

            <!-- Widget Syetem monitor -->

            <div class="col-span-1 md:col-span-1 bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-700 h-52 flex flex-col justify-center"
                 hx-get="{% url 'system_monitor' %}"
                 hx-trigger="load, every 8s">

                <div class="text-center text-gray-500 text-xs animate-pulse">
                    Chargement sys...
                </div>
            </div>





            <!-- Widget March√©s Financiers (TradingView) -->
            <div class="col-span-1 md:col-span-2 bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-700 h-96">
                <h3 class="font-bold text-orange-400 mb-4 text-lg">March√©s Financiers</h3>
                <div class="tradingview-widget-container">
                  <div class="tradingview-widget-container__widget"></div>
                  <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
                  {

                          "colorTheme": "dark",
                          "dateRange": "12M",
                          "showChart": false,
                          "locale": "fr",
                          "largeChartUrl": "",
                          "isTransparent": true,
                          "showSymbolLogo": true,
                          "showFloatingTooltip": false,
                          "width": "100%",
                          "height": "100%",
                          "tabs": [
                            {
                              "title": "Indices & Crypto",
                              "symbols": [
                                { "s": "FOREXCOM:SPXUSD", "d": "S&P 500" },
                                { "s": "FOREXCOM:NSXUSD", "d": "Nasdaq 100" },
                                { "s": "TSX:TSX", "d": "Toronto TSX" },
                                { "s": "BITSTAMP:BTCUSD", "d": "Bitcoin" },
                                { "s": "BITSTAMP:ETHUSD", "d": "Ethereum" },
                                { "s": "FX_IDC:EURUSD", "d": "EUR / USD" }
                              ]
                            }
                          ]
                        }
                  </script>
                </div>
            </div>

         <div class="col-span-1 md:col-span-2 bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 h-96 flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h3 id="cal-month-year" class="font-bold text-orange-400 text-lg capitalize">--</h3>
                        <div class="text-xs text-gray-500 bg-gray-900 px-2 py-1 rounded border border-gray-600">Aujourd'hui</div>
                    </div>

                    <div class="grid grid-cols-7 gap-1 text-center mb-2">
                        <div class="text-gray-500 text-xs font-bold">L</div>
                        <div class="text-gray-500 text-xs font-bold">M</div>
                        <div class="text-gray-500 text-xs font-bold">M</div>
                        <div class="text-gray-500 text-xs font-bold">J</div>
                        <div class="text-gray-500 text-xs font-bold">V</div>
                        <div class="text-gray-500 text-xs font-bold">S</div>
                        <div class="text-gray-500 text-xs font-bold">D</div>
                    </div>

                    <div id="cal-days" class="grid grid-cols-7 gap-1 text-center text-sm flex-1 content-start">
                    </div>
         </div>
            {% endif %}

            <!-- =================================== -->
            <!-- WIDGETS UTILISATEUR (Cat√©gories)   -->
            <!-- =================================== -->

            {% for widget in active_page.widgets.all %}
                {% include "partials/widget.html" %}
            {% endfor %}

        </div>

    {% else %}
        <!-- Message quand aucune page n'existe -->
        <div class="text-center text-gray-500 mt-10">Aucune page configur√©e. Lancez la commande seed_db !</div>
    {% endif %}
</div>

<!-- =================================== -->
<!-- MENU CONTEXTUEL LIEN (Clic droit)   -->
<!-- =================================== -->
<div id="context-menu" class="bg-gray-800 border border-gray-600 text-gray-200 rounded shadow-xl w-56 py-1 text-sm">
    <div class="px-4 py-2 font-bold border-b border-gray-700 text-gray-400 text-xs uppercase">Actions</div>
    <div class="relative group">
            <button class="w-full text-left px-4 py-2 hover:bg-blue-600 flex justify-between items-center">
                D√©placer vers... <span>‚ñ∂</span>
            </button>
            <div class="absolute left-full top-0 w-48 bg-gray-800 border border-gray-600 shadow-lg hidden group-hover:block rounded-r">
                {% for page in pages %}
                    {% if page != active_page %}
                    <form hx-post="{% url 'move_link' 0 %}" hx-trigger="click" hx-swap="none">
                        <input type="hidden" name="target_page_id" value="{{ page.id }}">
                        <button type="submit" class="w-full text-left px-4 py-2 hover:bg-blue-600 border-b border-gray-700 last:border-0">
                            {{ page.name }}
                        </button>
                    </form>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>


<!-- =================================== -->
<!-- MENU CONTEXTUEL WIDGET (D√©placement cat√©gorie) -->
<!-- =================================== -->
<div id="widget-context-menu" class="bg-gray-800 border border-gray-600 text-gray-200 rounded shadow-2xl w-56 py-1 text-sm fixed z-50 hidden">
    <div class="px-4 py-2 font-bold border-b border-gray-700 text-orange-400 text-xs uppercase bg-gray-900">
            D√©placer la cat√©gorie vers...
        </div>
        {% for page in pages %}
            {% if page != active_page %}
            <form action="{% url 'move_widget' 0 %}" method="POST" class="widget-move-form">
                {% csrf_token %}
                <input type="hidden" name="target_page_id" value="{{ page.id }}">
                <button type="submit" class="w-full text-left px-4 py-2 hover:bg-blue-600 border-b border-gray-700 last:border-0 flex justify-between group">
                    {{ page.name }}
                    <span class="hidden group-hover:inline">‚ûî</span>
                </button>
            </form>
            {% endif %}
        {% endfor %}
    </div>




<!-- =================================== -->
<!-- MODALES (Popups)                    -->
<!-- =================================== -->

<!-- Modale : Ajouter une page -->
<div id="modal-add-page" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
    <div class="bg-gray-800 border border-gray-600 p-6 rounded-lg shadow-2xl w-96">
            <h2 class="text-xl font-bold text-white mb-4">Nouvelle Page</h2>
            <form action="{% url 'create_page' %}" method="POST">
                {% csrf_token %}
                <label class="block text-gray-400 text-sm mb-2">Nom de la page</label>
                <input type="text" name="name" required autofocus
                       class="w-full bg-gray-900 text-white border border-gray-600 rounded p-2 mb-4 focus:border-blue-500 focus:outline-none"
                       placeholder="Ex: Cuisine, Voyage...">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('modal-add-page')"
                            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">Cr√©er</button>
                </div>
            </form>
        </div>
    </div>

<!-- Modale : Renommer la page -->
{% if active_page %}
    <div id="modal-rename-page" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-lg shadow-2xl w-96">
            <h2 class="text-xl font-bold text-white mb-4">Renommer la page</h2>
            <form action="{% url 'rename_page' active_page.id %}" method="POST">
                {% csrf_token %}
                <label class="block text-gray-400 text-sm mb-2">Nouveau nom</label>
                <input type="text" name="name" required value="{{ active_page.name }}"
                       class="w-full bg-gray-900 text-white border border-gray-600 rounded p-2 mb-4 focus:border-yellow-500 focus:outline-none">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('modal-rename-page')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded font-bold">Renommer</button>
                </div>
            </form>
        </div>
    </div>

<!-- Modale : Supprimer la page -->
<div id="modal-delete-page" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <div class="bg-gray-800 border border-red-900/50 p-6 rounded-lg shadow-2xl w-96 border-l-4 border-l-red-600">
            <h2 class="text-xl font-bold text-white mb-2">Supprimer la page ?</h2>
            <p class="text-gray-300 mb-6">
                Voulez-vous vraiment supprimer <strong>"{{ active_page.name }}"</strong> ?<br>
                Tous les widgets et les liens √† l'int√©rieur seront perdus.
            </p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="toggleModal('modal-delete-page')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                <a href="{% url 'delete_page' active_page.id %}" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold flex items-center">Confirmer</a>
            </div>
        </div>
    </div>

<!-- Modale : Ajouter une cat√©gorie (widget) -->
<div id="modal-add-widget" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
    <div class="bg-gray-800 border border-gray-600 p-6 rounded-lg shadow-2xl w-96">
        <h2 class="text-xl font-bold text-white mb-4">Nouvelle Cat√©gorie</h2>

        <form action="{% url 'add_widget' active_page.id %}" method="POST">
            {% csrf_token %}

            <label class="block text-gray-400 text-sm mb-2">Titre de la cat√©gorie</label>
            <input type="text" name="title" required autofocus
                   class="w-full bg-gray-900 text-white border border-gray-600 rounded p-2 mb-4 focus:border-blue-500 focus:outline-none"
                   placeholder="Ex: Sports, Notes...">

            <label class="block text-gray-400 text-sm mb-2">Type de contenu</label>
            <select name="widget_type" class="w-full bg-gray-900 text-white border border-gray-600 rounded p-2 mb-4 focus:border-blue-500 focus:outline-none">
                <option value="list">Liste de liens</option>
                <option value="note">Bloc-notes</option>
            </select>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="toggleModal('modal-add-widget')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">Cr√©er</button>
            </div>
        </form>
    </div>
</div>





<!-- Modale : Supprimer un widget -->
<div id="modal-delete-widget" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <div class="bg-gray-800 border border-red-900/50 p-6 rounded-lg shadow-2xl w-96 border-l-4 border-l-red-600">
            <h2 class="text-xl font-bold text-white mb-2">Supprimer la cat√©gorie ?</h2>
            <p class="text-gray-300 mb-6">
                Cette action est irr√©versible. Tous les liens contenus dans cette cat√©gorie seront perdus.
            </p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="toggleModal('modal-delete-widget')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                <a id="btn-confirm-delete-widget" href="#" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold flex items-center">Confirmer</a>
            </div>
        </div>
    </div>

<!-- Modale : Supprimer un lien -->
<div id="modal-delete-link" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <div class="bg-gray-800 border border-red-900/50 p-6 rounded-lg shadow-2xl w-96 border-l-4 border-l-red-600">
            <h2 class="text-xl font-bold text-white mb-2">Supprimer ce lien ?</h2>
            <p class="text-gray-300 mb-6">
                Voulez-vous vraiment retirer ce lien de votre tableau de bord ?
            </p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="toggleModal('modal-delete-link')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                <a id="btn-confirm-delete-link" href="#" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold flex items-center">Confirmer</a>
            </div>
        </div>
    </div>

    {% endif %}

<!-- =================================== -->
<!-- BOUTON MODE ZEN                     -->
<!-- =================================== -->
<button id="zen-toggle-btn"
        onclick="toggleZenMode()"
        class="fixed bottom-6 right-6 z-50 bg-gray-800 hover:bg-blue-600 text-gray-400 hover:text-white p-3 rounded-full shadow-2xl border border-gray-600 transition-all duration-300 opacity-50 hover:opacity-100"
        title="Mode Zen (Masquer l'interface)">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
    </svg>
</button>

<script>
    // --- GESTION DU MENU WIDGET (D√©placement cat√©gorie) ---
    const widgetMenu = document.getElementById('widget-context-menu');

    function showWidgetMenu(e, widgetId) {
        e.preventDefault();
        e.stopPropagation();

        // Positionnement sous la souris
        widgetMenu.style.left = e.clientX + 'px';
        widgetMenu.style.top = e.clientY + 'px';
        widgetMenu.classList.remove('hidden');

        // Mise √† jour de l'action du formulaire
        document.querySelectorAll('.widget-move-form').forEach(form => {
            let baseAction = form.getAttribute('action');
            let newAction = baseAction.replace(/\/\d+\/$/, '/' + widgetId + '/');
            form.setAttribute('action', newAction);
        });
    }

    // Fermeture des menus
    document.addEventListener('click', function(e) {
        if (widgetMenu && !widgetMenu.contains(e.target)) {
            widgetMenu.classList.add('hidden');
        }
        // Menu contextuel des liens aussi
        const linkMenu = document.getElementById('context-menu');
        if (linkMenu) linkMenu.style.display = 'none';
    });

    // --- GESTION DES MODALES (Popup) ---
    function toggleModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            const input = modal.querySelector('input');
            if(input) setTimeout(() => input.focus(), 100);
        } else {
            modal.classList.add('hidden');
        }
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            document.querySelectorAll('[id^="modal-"]').forEach(modal => modal.classList.add('hidden'));
            if(widgetMenu) widgetMenu.classList.add('hidden');
        }
    });

    // --- PR√âPARATION SUPPRESSION (Injection ID dans le lien) ---
    function confirmDeleteWidget(widgetId) {
        const confirmBtn = document.getElementById('btn-confirm-delete-widget');
        confirmBtn.href = "/widget/delete/" + widgetId + "/";
        toggleModal('modal-delete-widget');
    }

    function confirmDeleteLink(linkId) {
        const confirmBtn = document.getElementById('btn-confirm-delete-link');
        confirmBtn.href = "/link/delete/" + linkId + "/";
        toggleModal('modal-delete-link');
    }

    // --- AFFICHAGE FORMULAIRE LIEN ---
    function toggleForm(formId) {
        const form = document.getElementById(formId);
        if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
            form.querySelector('input').focus();
        } else {
            form.classList.add('hidden');
        }
    }

    // --- DRAG & DROP : LIENS ---
    document.querySelectorAll('.sortable-list').forEach(function(list) {
        new Sortable(list, {
            group: 'shared',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                var targetList = evt.to;
                var widgetId = targetList.getAttribute('data-widget-id');
                var listItems = targetList.querySelectorAll('li');
                var linkIds = Array.from(listItems).map(li => li.getAttribute('data-id'));

                var formData = new FormData();
                formData.append('widget_id', widgetId);
                linkIds.forEach(id => formData.append('link', id));

                fetch('/api/update-order/', { method: 'POST', body: formData });
            }
        });
    });

    // --- DRAG & DROP : CAT√âGORIES (Widgets) ---
    var widgetGrid = document.getElementById('widget-grid');
    if (widgetGrid) {
        new Sortable(widgetGrid, {
            animation: 150,
            handle: '.widget-handle',
            ghostClass: 'bg-gray-700',
            onEnd: function (evt) {
                var listItems = widgetGrid.children;
                var widgetIds = Array.from(listItems).map(div => div.getAttribute('data-id'));

                var formData = new FormData();
                widgetIds.forEach(id => formData.append('widget', id));

                fetch('/api/update-widget-order/', { method: 'POST', body: formData });
            }
        });
    }

    // --- MENU CONTEXTUEL : LIENS (Clic Droit) ---
    const linkMenu = document.getElementById('context-menu');
    function showContextMenu(e, linkId) {
        e.preventDefault();
        linkMenu.style.left = e.pageX + 'px';
        linkMenu.style.top = e.pageY + 'px';
        linkMenu.style.display = 'block';

        document.querySelectorAll('form[hx-post]').forEach(form => {
            let url = form.getAttribute('hx-post').replace(/\d+$/, linkId);
            form.setAttribute('hx-post', url);
            if (typeof htmx !== 'undefined') htmx.process(form);
        });
    }

    // --- HORLOGE DIGITALE ---
    function updateClock() {
        const clockEl = document.getElementById('clock-display');
        const dateEl = document.getElementById('date-display');
        if (!clockEl) return;

        const now = new Date();
        clockEl.textContent = now.toLocaleTimeString('fr-CA', { hour12: false });
        dateEl.textContent = now.toLocaleDateString('fr-CA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    if(document.getElementById('clock-display')) {
        setInterval(updateClock, 1000);
        updateClock();
    }


    // Configuration Open-Meteo pour Montr√©al
    const API_URL = "https://api.open-meteo.com/v1/forecast?latitude=45.5017&longitude=-73.5673&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=America%2FToronto&forecast_days=4";

    // Mapping des codes m√©t√©o WMO vers des Ic√¥nes/Emojis
    // Codes: https://open-meteo.com/en/docs
    function getWeatherIcon(code) {
        const icons = {
            0: '‚òÄÔ∏è', // Ciel d√©gag√©
            1: 'üå§Ô∏è', // Peu nuageux
            2: '‚õÖ', // Partiellement nuageux
            3: '‚òÅÔ∏è', // Couvert
            45: 'üå´Ô∏è', // Brouillard
            48: 'üå´Ô∏è',
            51: 'üå¶Ô∏è', // Bruine
            53: 'üå¶Ô∏è',
            55: 'üåßÔ∏è',
            61: 'üåßÔ∏è', // Pluie
            63: 'üåßÔ∏è',
            65: '‚õàÔ∏è',
            71: 'üå®Ô∏è', // Neige
            73: 'üå®Ô∏è',
            75: '‚ùÑÔ∏è',
            80: 'üå¶Ô∏è', // Averses
            81: 'üåßÔ∏è',
            82: '‚õàÔ∏è',
            95: '‚õàÔ∏è', // Orage
        };
        return icons[code] || '‚ùì';
    }

    function getDayName(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', { weekday: 'short' });
    }

    async function fetchWeather() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();

            // 1. Mise √† jour Actuelle
            document.getElementById('current-temp').innerText = Math.round(data.current.temperature_2m) + "¬∞C";
            document.getElementById('current-desc').innerText = "Code m√©t√©o: " + data.current.weather_code; // On pourrait traduire le code en texte ici

            // 2. Mise √† jour Pr√©visions (Jours suivants)
            const grid = document.getElementById('forecast-grid');
            grid.innerHTML = ''; // Vider les placeholders

            // On boucle sur les jours 1, 2 et 3 (on saute le 0 qui est aujourd'hui)
            for (let i = 1; i < 4; i++) {
                const dayName = getDayName(data.daily.time[i]);
                const maxTemp = Math.round(data.daily.temperature_2m_max[i]);
                const minTemp = Math.round(data.daily.temperature_2m_min[i]);
                const icon = getWeatherIcon(data.daily.weather_code[i]);

                const html = `
                    <div class="flex flex-col items-center p-2 rounded hover:bg-gray-700/50 transition-colors">
                        <span class="text-gray-400 text-xs uppercase font-bold mb-1">${dayName}.</span>
                        <span class="text-2xl mb-1">${icon}</span>
                        <div class="text-sm font-bold text-white">
                            ${maxTemp}¬∞ <span class="text-gray-500 text-xs font-normal">| ${minTemp}¬∞</span>
                        </div>
                    </div>
                `;
                grid.innerHTML += html;
            }

        } catch (error) {
            console.error("Erreur M√©t√©o:", error);
            document.getElementById('current-desc').innerText = "Erreur chargement";
        }
    }

    // Lancer au chargement
    fetchWeather();
    // Rafraichir toutes les 30 minutes
    setInterval(fetchWeather, 1800000);


    // --- MODE ZEN ---
    function toggleZenMode() {
        const body = document.body;
        body.classList.toggle('zen-mode');

        // Sauvegarde la pr√©f√©rence
        const isZen = body.classList.contains('zen-mode');
        localStorage.setItem('zenMode', isZen);

        // Change l'ic√¥ne du bouton (optionnel mais sympa)
        const btn = document.querySelector('#zen-toggle-btn svg path');
        if (isZen) {
            // Ic√¥ne "R√©duire" (Quitter le mode Zen)
            btn.setAttribute('d', 'M6 18L18 6M6 6l12 12');
        } else {
            // Ic√¥ne "Agrandir" (Entrer en mode Zen)
            btn.setAttribute('d', 'M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4');
        }
    }

    // Appliquer le mode au chargement de la page si c'√©tait activ√©
    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('zenMode') === 'true') {
            toggleZenMode(); // R√©active le mode sans animation
        }
    });


// ... vos scripts existants (Zen mode, M√©t√©o, etc.) ...

    // --- LOGIQUE CALENDRIER ---
    (function() {
        const date = new Date();
        const currYear = date.getFullYear();
        const currMonth = date.getMonth();
        const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];

        const title = document.getElementById('cal-month-year');
        const grid = document.getElementById('cal-days');

        // S√©curit√© : on ne lance le code que si le widget existe sur la page
        if(title && grid) {
            // 1. Titre
            title.innerText = `${monthNames[currMonth]} ${currYear}`;

            // 2. Calculs
            let firstDay = new Date(currYear, currMonth, 1).getDay();
            // Ajustement Lundi=0 (JS renvoie Dimanche=0)
            firstDay = firstDay === 0 ? 6 : firstDay - 1;
            const lastDate = new Date(currYear, currMonth + 1, 0).getDate();

            let html = "";
            // Cases vides d√©but de mois
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="p-1"></div>`;
            }
            // Jours du mois
            for (let i = 1; i <= lastDate; i++) {
                let isToday = (i === date.getDate() && currMonth === new Date().getMonth() && currYear === new Date().getFullYear());
                let classes = isToday
                    ? "bg-blue-600 text-white font-bold shadow-md transform scale-110 rounded-full w-8 h-8 flex items-center justify-center mx-auto"
                    : "text-gray-300 hover:bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center mx-auto transition-colors cursor-default";
                html += `<div class="${classes}">${i}</div>`;
            }
            grid.innerHTML = html;
        }
    })();


function openAllLinks(widgetId) {
        const widgetContainer = document.querySelector(`div[data-id="${widgetId}"]`);
        if (!widgetContainer) return;

        const links = widgetContainer.querySelectorAll('ul.sortable-list a');

        if (links.length > 5) {
            if (!confirm(`Voulez-vous ouvrir ${links.length} onglets ?`)) return;
        }

        // On transforme la liste en tableau pour utiliser l'index
        Array.from(links).forEach((link, index) => {
            if (link.href) {
                // Astuce : On attend 150ms * index avant d'ouvrir
                // Le 1er s'ouvre √† 0ms, le 2√®me √† 150ms, le 3√®me √† 300ms...
                setTimeout(() => {
                    window.open(link.href, '_blank');
                }, 150 * index);
            }
        });
    }

// --- DRAG & DROP : PAGES (Onglets) ---
    var navContainer = document.getElementById('main-nav');
    if (navContainer) {
        new Sortable(navContainer, {
            animation: 150,
            draggable: 'a', // On ne d√©place que les liens (pas les boutons + / edit)
            ghostClass: 'bg-gray-600',
            onEnd: function (evt) {
                var itemEl = evt.item;
                // On r√©cup√®re tous les liens <a> qui ont un data-id
                // (pour ignorer les boutons d'actions statiques)
                var listItems = navContainer.querySelectorAll('a[data-id]');
                var pageIds = Array.from(listItems).map(el => el.getAttribute('data-id'));

                var formData = new FormData();
                pageIds.forEach(id => formData.append('page', id));

                fetch('/api/update-page-order/', { method: 'POST', body: formData });
            }
        });
    }
</script>

</body>
</html>