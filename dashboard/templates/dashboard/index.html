<!--
    Ce fichier est le template principal et unique du tableau de bord personnel.
    Il est rendu par Django et contient toute la structure de l'interface.

    FONCTIONNEMENT :
    - Django : G√®re le rendu initial de la page, l'affichage des donn√©es (pages, widgets, liens)
      et traite les requ√™tes POST pour les modifications de la base de donn√©es.
    - HTMX : Utilis√© pour rendre l'application dynamique sans rechargement de page.
      Les actions comme l'ajout, la suppression ou la modification d'√©l√©ments
      se font via des requ√™tes AJAX d√©clench√©es par des attributs `hx-*`.
    - Tailwind CSS : Framework CSS utilis√© pour styliser l'ensemble de l'application
      avec une approche "utility-first". Le mode sombre (`dark`) est activ√© par d√©faut.
    - SortableJS : Biblioth√®que JavaScript qui permet de r√©organiser les √©l√©ments
      (liens, widgets, onglets) par glisser-d√©poser (Drag & Drop).
    - JavaScript Vanilla : Utilis√© pour la gestion des modales, des menus contextuels,
      de l'horloge, de la m√©t√©o, du calendrier et du "Mode Zen".

    STRUCTURE :
    1.  HEAD : Importation des librairies (Tailwind, HTMX, SortableJS) et styles CSS.
    2.  NAVIGATION PRINCIPALE : Barre sup√©rieure affichant les onglets (Pages) et les boutons de gestion.
    3.  BARRE DE RECHERCHE : Formulaire de recherche Google et bouton d'ajout de cat√©gorie.
    4.  CONTENU PRINCIPAL :
        - Affiche une grille de "widgets" (cat√©gories) pour la page active.
        - G√®re le cas sp√©cial de la page "Infos" pour afficher des widgets syst√®me (m√©t√©o, horloge, etc.).
        - Chaque widget est rendu via une inclusion du template partiel `partials/widget.html`.
    5.  MENUS CONTEXTUELS : Menus cach√©s qui apparaissent au clic droit sur un lien ou un widget.
    6.  MODALES : Fen√™tres pop-up pour les actions de cr√©ation, renommage et suppression.
    7.  BOUTONS FLOTTANTS : "Mode Zen" et "Backup".
    8.  SCRIPTS : Contient toute la logique c√¥t√© client (Drag & Drop, gestion des modales, horloge, etc.).
-->
{% load static %}
<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Perso</title>

    <!-- Importation des librairies JS -->
    <script src="{% static 'js/tailwind.js' %}"></script>
    <script src="{% static 'js/htmx.js' %}"></script>
    <script src="{% static 'js/sortable.js' %}"></script>

    <!-- Configuration de Tailwind CSS en JavaScript -->
    <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            gray: {
                                900: '#111827',
                                800: '#1f2937',
                                700: '#374151',
                            }
                        }
                    }
                }
            }
    </script>

    <!-- Styles CSS additionnels -->
    <style>
        #context-menu { display: none; position: absolute; z-index: 50; }
        .sortable-ghost { opacity: 0.4; background-color: #4B5563; }

        /* --- MODE ZEN --- */
        /* Ces classes masquent les √©l√©ments d'interface quand le body a la classe .zen-mode */
        body.zen-mode #main-nav { display: none !important; }
        body.zen-mode #search-container { display: none !important; }
        body.zen-mode .main-content { padding-top: 2rem !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen select-none"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'> <!-- Ajoute le token CSRF √† toutes les requ√™tes HTMX -->

<!-- =================================== -->
<!-- NAVIGATION PRINCIPALE (ONGLETS/PAGES) -->
<!-- =================================== -->
<nav id="main-nav" class="flex items-center space-x-2 p-3 bg-black border-b border-gray-800 overflow-x-auto">
    <div class="font-bold text-xl mr-4 text-white">‚â°</div>

    <!-- Boucle sur les pages pour afficher les onglets -->
    {% for page in pages %}
        <a href="{% url 'index' page.slug %}"
           data-id="{{ page.id }}"
           class="px-4 py-2 rounded transition-colors duration-200 whitespace-nowrap cursor-move
           {% if page == active_page %}bg-blue-600 text-white font-bold shadow-md{% else %}bg-gray-800 hover:bg-gray-700 text-gray-300{% endif %}">
            {{ page.name }}
        </a>
    {% endfor %}

    <!-- Boutons de gestion des pages -->
    <button onclick="toggleModal('modal-add-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-green-600 text-gray-400 hover:text-white font-bold transition-colors"
            title="Nouvelle page">
        +
    </button>

    {% if active_page %}
    <div class="h-6 w-px bg-gray-700 mx-2"></div>

    <button onclick="toggleModal('modal-rename-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-yellow-600 text-gray-400 hover:text-white transition-colors"
            title="Renommer la page active">
        ‚úé
    </button>

    <button onclick="toggleModal('modal-delete-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-red-600 text-gray-400 hover:text-white transition-colors"
            title="Supprimer la page active">
        üóë
    </button>
    {% endif %}
</nav>

<!-- ======================-->
<!-- BARRE DE RECHERCHE    -->
<!-- ======================-->
<div id="search-container" class="flex justify-center items-center py-8 px-4 gap-4">
    <!-- Formulaire de recherche Google -->
    <form action="https://www.google.com/search" method="GET" target="_blank"
          class="w-full max-w-2xl relative group">
        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>

        <input type="text"
               id="search-input"
               name="q"
               placeholder="Rechercher (Tapez pour filtrer, Entr√©e pour Google)..."
               autofocus
               onkeyup="liveSearch()"
               class="w-full bg-gray-800 text-white text-lg border border-gray-700 rounded-full py-3 pl-12 pr-4 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all placeholder-gray-500">

        <div class="absolute inset-0 rounded-full bg-blue-500 opacity-0 group-focus-within:opacity-20 blur-md transition-opacity -z-10"></div>
    </form>

    {% if active_page %}
    <!-- Bouton pour ajouter une nouvelle cat√©gorie (widget) √† la page active -->
    <button onclick="toggleModal('modal-add-widget')"
            class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-full shadow-lg flex items-center font-bold transition-colors whitespace-nowrap"
            title="Ajouter une cat√©gorie √† cette page">
        <span class="text-xl mr-2 leading-none">+</span> Cat√©gorie
    </button>
    {% endif %}
</div>

<!-- =================================== -->
<!-- CONTENU PRINCIPAL (GRILLE DE WIDGETS) -->
<!-- =================================== -->
<div class="p-6 main-content">
    {% if active_page %}

        <!-- Grille responsive qui contient tous les widgets -->
        <div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">


        {% if active_page.slug == 'infos' %}
            {% include "partials/widgets_infos.html" %}
        {% endif %}


            <!-- Condition sp√©ciale : si la page s'appelle 'infos', on affiche les widgets syst√®me -->

            <!-- Boucle pour afficher les widgets cr√©√©s par l'utilisateur -->
            {% for widget in active_page.widgets.all %}
                {% if active_page.slug == 'infos' and widget.title == "Scripts" %}
                    {% else %}
                    {% include "partials/widget.html" %}
                {% endif %}
            {% endfor %}

        </div>

    {% else %}
        <!-- Message affich√© si aucune page n'est configur√©e -->
        <div class="text-center text-gray-500 mt-10">Aucune page configur√©e. Lancez la commande seed_db !</div>
    {% endif %}
</div>

<!-- =================================== -->
<!-- MENUS CONTEXTUELS (CLIC DROIT)      -->
<!-- =================================== -->
{% include "partials/menus.html" %}

<!-- =================================== -->
<!-- MODALES (FEN√äTRES POP-UP)           -->
<!-- =================================== -->

<!-- Modale : Ajouter une page -->
<div id="modal-add-page" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
    <!-- ... Formulaire d'ajout de page ... -->
    <div class="bg-gray-800 border border-gray-600 p-6 rounded-lg shadow-2xl w-96">
            <h2 class="text-xl font-bold text-white mb-4">Nouvelle Page</h2>
            <form action="{% url 'create_page' %}" method="POST">
                {% csrf_token %}
                <label class="block text-gray-400 text-sm mb-2">Nom de la page</label>
                <input type="text" name="name" required autofocus
                       class="w-full bg-gray-900 text-white border border-gray-600 rounded p-2 mb-4 focus:border-blue-500 focus:outline-none"
                       placeholder="Ex: Cuisine, Voyage...">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('modal-add-page')"
                            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">Cr√©er</button>
                </div>
            </form>
        </div>
    </div>

{% if active_page %}
    <!-- Modale : Renommer la page -->
    <div id="modal-rename-page" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <!-- ... Formulaire de renommage de page ... -->
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-lg shadow-2xl w-96">
            <h2 class="text-xl font-bold text-white mb-4">Renommer la page</h2>
            <form action="{% url 'rename_page' active_page.id %}" method="POST">
                {% csrf_token %}
                <label class="block text-gray-400 text-sm mb-2">Nouveau nom</label>
                <input type="text" name="name" required value="{{ active_page.name }}"
                       class="w-full bg-gray-900 text-white border border-gray-600 rounded p-2 mb-4 focus:border-yellow-500 focus:outline-none">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('modal-rename-page')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded font-bold">Renommer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale : Supprimer la page -->
    <div id="modal-delete-page" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <!-- ... Confirmation de suppression de page ... -->
        <div class="bg-gray-800 border border-red-900/50 p-6 rounded-lg shadow-2xl w-96 border-l-4 border-l-red-600">
            <h2 class="text-xl font-bold text-white mb-2">Supprimer la page ?</h2>
            <p class="text-gray-300 mb-6">
                Voulez-vous vraiment supprimer <strong>"{{ active_page.name }}"</strong> ?<br>
                Tous les widgets et les liens √† l'int√©rieur seront perdus.
            </p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="toggleModal('modal-delete-page')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                <a href="{% url 'delete_page' active_page.id %}" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold flex items-center">Confirmer</a>
            </div>
        </div>
    </div>

    <!-- Modale : Ajouter une cat√©gorie (widget) -->
    <div id="modal-add-widget" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <!-- ... Formulaire d'ajout de widget ... -->
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-lg shadow-2xl w-96">
            <h2 class="text-xl font-bold text-white mb-4">Nouvelle Cat√©gorie</h2>

            <form action="{% url 'add_widget' active_page.id %}" method="POST">
                {% csrf_token %}

                <label class="block text-gray-400 text-sm mb-2">Titre de la cat√©gorie</label>
                <input type="text" name="title" required autofocus
                       class="w-full bg-gray-900 text-white border border-gray-600 rounded p-2 mb-4 focus:border-blue-500 focus:outline-none"
                       placeholder="Ex: Sports, Notes...">

                <label class="block text-gray-400 text-sm mb-2">Type de contenu</label>
                <select name="widget_type" class="w-full bg-gray-900 text-white border border-gray-600 rounded p-2 mb-4 focus:border-blue-500 focus:outline-none">
                    <option value="list">Liste de liens</option>
                    <option value="note">Bloc-notes</option>
                    <option value="command">Lanceur de scripts</option>
                </select>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal('modal-add-widget')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">Cr√©er</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale : Supprimer un widget -->
    <div id="modal-delete-widget" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <!-- ... Confirmation de suppression de widget ... -->
        <div class="bg-gray-800 border border-red-900/50 p-6 rounded-lg shadow-2xl w-96 border-l-4 border-l-red-600">
            <h2 class="text-xl font-bold text-white mb-2">Supprimer la cat√©gorie ?</h2>
            <p class="text-gray-300 mb-6">
                Cette action est irr√©versible. Tous les liens contenus dans cette cat√©gorie seront perdus.
            </p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="toggleModal('modal-delete-widget')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                <a id="btn-confirm-delete-widget" href="#" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold flex items-center">Confirmer</a>
            </div>
        </div>
    </div>

    <!-- Modale : Supprimer un lien -->
    <div id="modal-delete-link" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
       <!-- ... Confirmation de suppression de lien ... -->
        <div class="bg-gray-800 border border-red-900/50 p-6 rounded-lg shadow-2xl w-96 border-l-4 border-l-red-600">
            <h2 class="text-xl font-bold text-white mb-2">Supprimer ce lien ?</h2>
            <p class="text-gray-300 mb-6">
                Voulez-vous vraiment retirer ce lien de votre tableau de bord ?
            </p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="toggleModal('modal-delete-link')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Annuler</button>
                <a id="btn-confirm-delete-link" href="#" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold flex items-center">Confirmer</a>
            </div>
        </div>
    </div>

{% endif %}

<!-- =================================== -->
<!-- BOUTONS FLOTTANTS                   -->
<!-- =================================== -->

<!-- Bouton pour activer/d√©sactiver le "Mode Zen" -->
<button id="zen-toggle-btn"
        onclick="toggleZenMode()"
        class="fixed bottom-6 right-6 z-50 bg-gray-800 hover:bg-blue-600 text-gray-400 hover:text-white p-3 rounded-full shadow-2xl border border-gray-600 transition-all duration-300 opacity-50 hover:opacity-100"
        title="Mode Zen (Masquer l'interface)">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
    </svg>
</button>

<!-- Bouton pour t√©l√©charger la sauvegarde -->
<a href="{% url 'download_backup' %}"
   class="fixed bottom-20 right-6 z-50 bg-gray-800 hover:bg-green-600 text-gray-400 hover:text-white p-3 rounded-full shadow-2xl border border-gray-600 transition-all duration-300 opacity-50 hover:opacity-100"
   title="T√©l√©charger une sauvegarde (.zip)">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    </svg>
</a>

<!-- =================================== -->
<!-- SCRIPTS JAVASCRIPT                  -->
<!-- =================================== -->
<script>
   // --- GESTION DES MENUS CONTEXTUELS ---
    // ... (code pour afficher/cacher les menus au clic droit et mettr
    const widgetMenu = document.getElementById('widget-context-menu');

    function showWidgetMenu(e, widgetId) {
        e.preventDefault();
        e.stopPropagation();

        widgetMenu.style.left = e.clientX + 'px';
        widgetMenu.style.top = e.clientY + 'px';
        widgetMenu.classList.remove('hidden');

        document.querySelectorAll('.widget-move-form').forEach(form => {
            let baseAction = form.getAttribute('action');
            let newAction = baseAction.replace(/\/\d+\/$/, '/' + widgetId + '/');
            form.setAttribute('action', newAction);
        });
    }

    document.addEventListener('click', function(e) {
        if (widgetMenu && !widgetMenu.contains(e.target)) {
            widgetMenu.classList.add('hidden');
        }
        const linkMenu = document.getElementById('context-menu');
        if (linkMenu) linkMenu.style.display = 'none';
    });

    // --- GESTION DES MODALES (Popup) ---
    function toggleModal(modalId) {
       // ... (code pour afficher/cacher les modales et g√©rer le focus)
        const modal = document.getElementById(modalId);
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            const input = modal.querySelector('input');
            if(input) setTimeout(() => input.focus(), 100);
        } else {
            modal.classList.add('hidden');
        }
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            document.querySelectorAll('[id^="modal-"]').forEach(modal => modal.classList.add('hidden'));
            if(widgetMenu) widgetMenu.classList.add('hidden');
        }
    });

    // --- PR√âPARATION SUPPRESSION ---
    function confirmDeleteWidget(widgetId) {
        const confirmBtn = document.getElementById('btn-confirm-delete-widget');
        confirmBtn.href = "/widget/delete/" + widgetId + "/";
        toggleModal('modal-delete-widget');
    }

    function confirmDeleteLink(linkId) {
        const confirmBtn = document.getElementById('btn-confirm-delete-link');
        confirmBtn.href = "/link/delete/" + linkId + "/";
        toggleModal('modal-delete-link');
    }

    // --- AFFICHAGE FORMULAIRE LIEN ---
    function toggleForm(formId) {
        const form = document.getElementById(formId);
        if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
            form.querySelector('input').focus();
        } else {
            form.classList.add('hidden');
        }
    }

    // --- DRAG & DROP : LIENS ---
    document.querySelectorAll('.sortable-list').forEach(function(list) {
        new Sortable(list, {
            group: 'shared',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                var targetList = evt.to;
                var widgetId = targetList.getAttribute('data-widget-id');
                var listItems = targetList.querySelectorAll('li');
                var linkIds = Array.from(listItems).map(li => li.getAttribute('data-id'));

                var formData = new FormData();
                formData.append('widget_id', widgetId);
                linkIds.forEach(id => formData.append('link', id));

                fetch('/api/update-order/', { method: 'POST', body: formData });
            }
        });
    });

    // --- DRAG & DROP : CAT√âGORIES (Widgets) ---
    var widgetGrid = document.getElementById('widget-grid');
    if (widgetGrid) {
        new Sortable(widgetGrid, {
            animation: 150,
            handle: '.widget-handle',
            ghostClass: 'bg-gray-700',
            onEnd: function (evt) {
                var listItems = widgetGrid.children;
                var widgetIds = Array.from(listItems).map(div => div.getAttribute('data-id'));

                var formData = new FormData();
                widgetIds.forEach(id => formData.append('widget', id));

                fetch('/api/update-widget-order/', { method: 'POST', body: formData });
            }
        });
    }

    // --- DRAG & DROP : PAGES (Onglets) ---
    var navContainer = document.getElementById('main-nav');
    if (navContainer) {
        new Sortable(navContainer, {
            animation: 150,
            draggable: 'a', // On ne d√©place que les liens (pas les boutons + / edit)
            ghostClass: 'bg-gray-600',
            onEnd: function (evt) {
                var itemEl = evt.item;
                var listItems = navContainer.querySelectorAll('a[data-id]');
                var pageIds = Array.from(listItems).map(el => el.getAttribute('data-id'));

                var formData = new FormData();
                pageIds.forEach(id => formData.append('page', id));

                fetch('/api/update-page-order/', { method: 'POST', body: formData });
            }
        });
    }

    // --- MENU CONTEXTUEL : LIENS (Clic Droit) ---
    const linkMenu = document.getElementById('context-menu');
    function showContextMenu(e, linkId) {
        e.preventDefault();
        linkMenu.style.left = e.pageX + 'px';
        linkMenu.style.top = e.pageY + 'px';
        linkMenu.style.display = 'block';

        document.querySelectorAll('form[hx-post]').forEach(form => {
            let url = form.getAttribute('hx-post').replace(/\d+$/, linkId);
            form.setAttribute('hx-post', url);
            if (typeof htmx !== 'undefined') htmx.process(form);
        });
    }

    // --- HORLOGE DIGITALE ---
    function updateClock() {
        const clockEl = document.getElementById('clock-display');
        const dateEl = document.getElementById('date-display');
        if (!clockEl) return;

        const now = new Date();
        clockEl.textContent = now.toLocaleTimeString('fr-CA', { hour12: false });
        dateEl.textContent = now.toLocaleDateString('fr-CA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    if(document.getElementById('clock-display')) {
        setInterval(updateClock, 1000);
        updateClock();
    }


    // Configuration Open-Meteo pour Montr√©al
    const API_URL = "https://api.open-meteo.com/v1/forecast?latitude=45.5017&longitude=-73.5673&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=America%2FToronto&forecast_days=4";

    function getWeatherIcon(code) {
        const icons = {
            0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
            51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è', 61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: '‚õàÔ∏è',
            71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: '‚ùÑÔ∏è', 80: 'üå¶Ô∏è', 81: 'üåßÔ∏è', 82: '‚õàÔ∏è', 95: '‚õàÔ∏è',
        };
        return icons[code] || '‚ùì';
    }

    function getDayName(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', { weekday: 'short' });
    }

    async function fetchWeather() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();

            document.getElementById('current-temp').innerText = Math.round(data.current.temperature_2m) + "¬∞C";
            document.getElementById('current-desc').innerText = "Code m√©t√©o: " + data.current.weather_code;

            const grid = document.getElementById('forecast-grid');
            grid.innerHTML = '';

            for (let i = 1; i < 4; i++) {
                const dayName = getDayName(data.daily.time[i]);
                const maxTemp = Math.round(data.daily.temperature_2m_max[i]);
                const minTemp = Math.round(data.daily.temperature_2m_min[i]);
                const icon = getWeatherIcon(data.daily.weather_code[i]);

                const html = `
                    <div class="flex flex-col items-center p-2 rounded hover:bg-gray-700/50 transition-colors">
                        <span class="text-gray-400 text-xs uppercase font-bold mb-1">${dayName}.</span>
                        <span class="text-2xl mb-1">${icon}</span>
                        <div class="text-sm font-bold text-white">
                            ${maxTemp}¬∞ <span class="text-gray-500 text-xs font-normal">| ${minTemp}¬∞</span>
                        </div>
                    </div>
                `;
                grid.innerHTML += html;
            }

        } catch (error) {
            console.error("Erreur M√©t√©o:", error);
            if(document.getElementById('current-desc')) document.getElementById('current-desc').innerText = "Erreur";
        }
    }

    fetchWeather();
    setInterval(fetchWeather, 1800000);


    // --- MODE ZEN ---
    function toggleZenMode() {
        const body = document.body;
        body.classList.toggle('zen-mode');
        const isZen = body.classList.contains('zen-mode');
        localStorage.setItem('zenMode', isZen);
        const btn = document.querySelector('#zen-toggle-btn svg path');
        if (isZen) {
            btn.setAttribute('d', 'M6 18L18 6M6 6l12 12');
        } else {
            btn.setAttribute('d', 'M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('zenMode') === 'true') {
            toggleZenMode();
        }
    });

    // --- CALENDRIER ---
    (function() {
        const date = new Date();
        const currYear = date.getFullYear();
        const currMonth = date.getMonth();
        const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];

        const title = document.getElementById('cal-month-year');
        const grid = document.getElementById('cal-days');

        if(title && grid) {
            title.innerText = `${monthNames[currMonth]} ${currYear}`;
            let firstDay = new Date(currYear, currMonth, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1;
            const lastDate = new Date(currYear, currMonth + 1, 0).getDate();

            let html = "";
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="p-1"></div>`;
            }
            for (let i = 1; i <= lastDate; i++) {
                let isToday = (i === date.getDate() && currMonth === new Date().getMonth() && currYear === new Date().getFullYear());
                let classes = isToday
                    ? "bg-blue-600 text-white font-bold shadow-md transform scale-110 rounded-full w-8 h-8 flex items-center justify-center mx-auto"
                    : "text-gray-300 hover:bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center mx-auto transition-colors cursor-default";
                html += `<div class="${classes}">${i}</div>`;
            }
            grid.innerHTML = html;
        }
    })();

    // --- OPEN ALL LINKS ---
    function openAllLinks(widgetId) {
        const widgetContainer = document.querySelector(`div[data-id="${widgetId}"]`);
        if (!widgetContainer) return;

        const links = widgetContainer.querySelectorAll('ul.sortable-list a');

        if (links.length > 5) {
            if (!confirm(`Voulez-vous ouvrir ${links.length} onglets ?`)) return;
        }

        Array.from(links).forEach((link, index) => {
            if (link.href) {
                setTimeout(() => {
                    window.open(link.href, '_blank');
                }, 150 * index);
            }
        });
    }

    // --- LIVE SEARCH ---
    function liveSearch() {
        let input = document.getElementById('search-input');
        let filter = input.value.toLowerCase();
        let widgets = document.querySelectorAll('.group\\/widget');

        widgets.forEach(function(widget) {
            let widgetMatch = false;

            // Check Title
            let titleEl = widget.querySelector('h3, h2, .font-bold');
            if (titleEl && titleEl.innerText.toLowerCase().includes(filter)) {
                widgetMatch = true;
            }

            // Check Links
            let links = widget.querySelectorAll('li');
            let hasVisibleLink = false;

            links.forEach(function(link) {
                let text = link.innerText.toLowerCase();
                if (text.includes(filter) || widgetMatch) {
                    link.style.display = "";
                    hasVisibleLink = true;
                } else {
                    link.style.display = "none";
                }
            });

            // Check Notes
            let note = widget.querySelector('textarea');
            if (note) {
                let noteText = note.value.toLowerCase();
                if (noteText.includes(filter) || widgetMatch) {
                    hasVisibleLink = true;
                }
            }

            if (widgetMatch || hasVisibleLink || filter === "") {
                widget.style.display = "";
            } else {
                widget.style.display = "none";
            }
        });
    }

    // --- REINIT SORTABLE APRES HTMX LOAD ---
    htmx.onLoad(function(content) {
        var sortables = content.querySelectorAll('.sortable-list');
        sortables.forEach(function(list) {
             new Sortable(list, {
                group: 'shared',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    var targetList = evt.to;
                    var widgetId = targetList.getAttribute('data-widget-id');
                    var listItems = targetList.querySelectorAll('li');
                    var linkIds = Array.from(listItems).map(li => li.getAttribute('data-id'));
                    var formData = new FormData();
                    formData.append('widget_id', widgetId);
                    linkIds.forEach(id => formData.append('link', id));
                    fetch('/api/update-order/', { method: 'POST', body: formData });
                }
            });
        });
    });

</script>
</body>
</html>