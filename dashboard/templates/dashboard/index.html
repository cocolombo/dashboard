<!--
    Ce fichier est le template principal et unique du tableau de bord personnel.
    Il est rendu par Django et contient toute la structure de l'interface.

    FONCTIONNEMENT :
    - Django : GÃ¨re le rendu initial de la page, l'affichage des donnÃ©es (pages, widgets, liens)
      et traite les requÃªtes POST pour les modifications de la base de donnÃ©es.
    - HTMX : UtilisÃ© pour rendre l'application dynamique sans rechargement de page.
      Les actions comme l'ajout, la suppression ou la modification d'Ã©lÃ©ments
      se font via des requÃªtes AJAX dÃ©clenchÃ©es par des attributs `hx-*`.
    - Tailwind CSS : Framework CSS utilisÃ© pour styliser l'ensemble de l'application
      avec une approche "utility-first". Le mode sombre (`dark`) est activÃ© par dÃ©faut.
    - SortableJS : BibliothÃ¨que JavaScript qui permet de rÃ©organiser les Ã©lÃ©ments
      (liens, widgets, onglets) par glisser-dÃ©poser (Drag & Drop).
    - JavaScript Vanilla : UtilisÃ© pour la gestion des modales, des menus contextuels,
      de l'horloge, de la mÃ©tÃ©o, du calendrier et du "Mode Zen".

    STRUCTURE :
    1.  HEAD : Importation des librairies (Tailwind, HTMX, SortableJS) et styles CSS.
    2.  NAVIGATION PRINCIPALE : Barre supÃ©rieure affichant les onglets (Pages) et les boutons de gestion.
    3.  BARRE DE RECHERCHE : Formulaire de recherche Google et bouton d'ajout de catÃ©gorie.
    4.  CONTENU PRINCIPAL :
        - Affiche une grille de "widgets" (catÃ©gories) pour la page active.
        - GÃ¨re le cas spÃ©cial de la page "Infos" pour afficher des widgets systÃ¨me (mÃ©tÃ©o, horloge, etc.).
        - Chaque widget est rendu via une inclusion du template partiel `partials/widget.html`.
    5.  MENUS CONTEXTUELS : Menus cachÃ©s qui apparaissent au clic droit sur un lien ou un widget.
    6.  MODALES : FenÃªtres pop-up pour les actions de crÃ©ation, renommage et suppression.
    7.  BOUTONS FLOTTANTS : "Mode Zen" et "Backup".
    8.  SCRIPTS : Contient toute la logique cÃ´tÃ© client (Drag & Drop, gestion des modales, horloge, etc.).
-->
{% load static %}
<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Perso</title>

    <!-- Importation des librairies JS -->
    <script src="{% static 'js/tailwind.js' %}"></script>
    <script src="{% static 'js/htmx.js' %}"></script>
    <script src="{% static 'js/sortable.js' %}"></script>

    <!-- Configuration de Tailwind CSS en JavaScript -->
    <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            gray: {
                                900: '#111827',
                                800: '#1f2937',
                                700: '#374151',
                            }
                        }
                    }
                }
            }
    </script>

    <!-- Styles CSS additionnels -->
    <style>
        #context-menu { display: none; position: absolute; z-index: 50; }
        .sortable-ghost { opacity: 0.4; background-color: #4B5563; }

        /* --- MODE ZEN --- */
        /* Ces classes masquent les Ã©lÃ©ments d'interface quand le body a la classe .zen-mode */
        body.zen-mode #main-nav { display: none !important; }
        body.zen-mode #search-container { display: none !important; }
        body.zen-mode .main-content { padding-top: 2rem !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen select-none"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'> <!-- Ajoute le token CSRF Ã  toutes les requÃªtes HTMX -->

<!-- =================================== -->
<!-- NAVIGATION PRINCIPALE (ONGLETS/PAGES) -->
<!-- =================================== -->
<nav id="main-nav" class="flex items-center space-x-2 p-3 bg-black border-b border-gray-800 overflow-x-auto">
    <div class="font-bold text-xl mr-4 text-white">â‰¡</div>

    <!-- Boucle sur les pages pour afficher les onglets -->
    {% for page in pages %}
        <a href="{% url 'index' page.slug %}"
           data-id="{{ page.id }}"
           class="px-4 py-2 rounded transition-colors duration-200 whitespace-nowrap cursor-move
           {% if page == active_page %}bg-blue-600 text-white font-bold shadow-md{% else %}bg-gray-800 hover:bg-gray-700 text-gray-300{% endif %}">
            {{ page.name }}
        </a>
    {% endfor %}

    <!-- Boutons de gestion des pages -->
    <button onclick="toggleModal('modal-add-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-green-600 text-gray-400 hover:text-white font-bold transition-colors"
            title="Nouvelle page">
        +
    </button>

    {% if active_page %}
    <div class="h-6 w-px bg-gray-700 mx-2"></div>

    <button onclick="toggleModal('modal-rename-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-yellow-600 text-gray-400 hover:text-white transition-colors"
            title="Renommer la page active">
        âœŽ
    </button>

    <button onclick="toggleModal('modal-delete-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-red-600 text-gray-400 hover:text-white transition-colors"
            title="Supprimer la page active">
        ðŸ—‘
    </button>
    {% endif %}
</nav>

<!-- ======================-->
<!-- BARRE DE RECHERCHE    -->
<!-- ======================-->
<div id="search-container" class="flex justify-center items-center py-8 px-4 gap-4">
    <!-- Formulaire de recherche Google -->
    <form action="https://www.google.com/search" method="GET" target="_blank"
          class="w-full max-w-2xl relative group">
        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>

        <input type="text"
               id="search-input"
               name="q"
               placeholder="Rechercher (Tapez pour filtrer, EntrÃ©e pour Google)..."
               autofocus
               onkeyup="liveSearch()"
               class="w-full bg-gray-800 text-white text-lg border border-gray-700 rounded-full py-3 pl-12 pr-4 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all placeholder-gray-500">

        <div class="absolute inset-0 rounded-full bg-blue-500 opacity-0 group-focus-within:opacity-20 blur-md transition-opacity -z-10"></div>
    </form>

    {% if active_page %}
    <!-- Bouton pour ajouter une nouvelle catÃ©gorie (widget) Ã  la page active -->
    <button onclick="toggleModal('modal-add-widget')"
            class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-full shadow-lg flex items-center font-bold transition-colors whitespace-nowrap"
            title="Ajouter une catÃ©gorie Ã  cette page">
        <span class="text-xl mr-2 leading-none">+</span> CatÃ©gorie
    </button>
    {% endif %}
</div>

<!-- =================================== -->
<!-- CONTENU PRINCIPAL (GRILLE DE WIDGETS) -->
<!-- =================================== -->
<div class="p-6 main-content">
    {% if active_page %}

        <!-- Grille responsive qui contient tous les widgets -->
        <div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            {% if active_page.slug == 'infos' %}
                {% include "partials/widgets_infos.html" %}
            {% endif %}

            <!-- Boucle pour afficher les widgets crÃ©Ã©s par l'utilisateur -->
            {% for widget in active_page.widgets.all %}
                {% if active_page.slug == 'infos' and widget.title == "Scripts" %}
                    {% else %}
                    {% include "partials/widget.html" %}
                {% endif %}
            {% endfor %}

        </div>

    {% else %}
        <!-- Message affichÃ© si aucune page n'est configurÃ©e -->
        <div class="text-center text-gray-500 mt-10">Aucune page configurÃ©e. Lancez la commande seed_db !</div>
    {% endif %}
</div>

<!-- =================================== -->
<!-- MENUS CONTEXTUELS (CLIC DROIT)      -->
<!-- =================================== -->
{% include "partials/menus.html" %}

<!-- =================================== -->
<!-- MODALES (FENÃŠTRES POP-UP)           -->
<!-- =================================== -->
{% include "partials/modals.html" %}


<!-- =================================== -->
<!-- BOUTONS FLOTTANTS                   -->
<!-- =================================== -->

<!-- Bouton pour activer/dÃ©sactiver le "Mode Zen" -->
<button id="zen-toggle-btn"
        onclick="toggleZenMode()"
        class="fixed bottom-6 right-6 z-50 bg-gray-800 hover:bg-blue-600 text-gray-400 hover:text-white p-3 rounded-full shadow-2xl border border-gray-600 transition-all duration-300 opacity-50 hover:opacity-100"
        title="Mode Zen (Masquer l'interface)">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
    </svg>
</button>

<!-- Bouton pour tÃ©lÃ©charger la sauvegarde -->
<a href="{% url 'download_backup' %}"
   class="fixed bottom-20 right-6 z-50 bg-gray-800 hover:bg-green-600 text-gray-400 hover:text-white p-3 rounded-full shadow-2xl border border-gray-600 transition-all duration-300 opacity-50 hover:opacity-100"
   title="TÃ©lÃ©charger une sauvegarde (.zip)">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    </svg>
</a>

<!-- =================================== -->
<!-- SCRIPTS JAVASCRIPT                  -->
<!-- =================================== -->
{% include "partials/scripts.html" %}
</body>
</html>