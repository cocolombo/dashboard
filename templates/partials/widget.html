<div class="bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-700 flex flex-col group/widget mb-6 transition-all duration-300 h-full relative"
     id="widget-{{ widget.id }}"
     data-id="{{ widget.id }}">

    <div class="widget-handle flex justify-between items-center mb-3 border-b border-gray-600 pb-2 cursor-move select-none">

        {% include "partials/widget_title.html" %}

        <div class="flex items-center space-x-1">

            {% if widget.widget_type == 'list' or not widget.widget_type %}
            <button onclick="openAllLinks('{{ widget.id }}')"
                    class="text-gray-500 hover:text-purple-400 font-bold text-lg px-2 transition-colors cursor-pointer"
                    title="Ouvrir tous les liens">â‡±</button>
            {% endif %}

            <button onclick="showWidgetMenu(event, '{{ widget.id }}')"
                    class="text-gray-500 hover:text-blue-400 font-bold text-lg px-2 transition-colors cursor-pointer"
                    title="DÃ©placer">âžœ</button>

            <button onclick="confirmDeleteWidget('{{ widget.id }}')"
                    class="text-gray-500 hover:text-red-500 font-bold text-lg px-2 transition-colors cursor-pointer"
                    title="Supprimer">ðŸ—‘</button>

            {% if widget.widget_type != 'note' %}
            <button onclick="toggleForm('form-{{ widget.id }}')"
                    class="text-gray-500 hover:text-green-400 font-bold text-2xl leading-none px-2 transition-colors cursor-pointer"
                    title="Ajouter">+</button>
            {% endif %}
        </div>
    </div>

    <div class="widget-content flex-1 flex flex-col relative">

        {% if widget.widget_type == 'list' or not widget.widget_type %}

            <form id="form-{{ widget.id }}" action="{% url 'add_link' widget.id %}" method="POST" class="hidden mb-3 bg-gray-900 p-3 rounded border border-gray-600 absolute top-0 left-0 right-0 z-10 shadow-xl">
                {% csrf_token %}
                <input type="text" name="title" placeholder="Titre" required class="w-full mb-2 bg-gray-800 text-white px-2 py-1 rounded border border-gray-700">
                <input type="url" name="url" placeholder="URL (Optionnel)" class="w-full mb-2 bg-gray-800 text-white px-2 py-1 rounded border border-gray-700">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-1 rounded text-sm">Ajouter</button>
            </form>

            <ul class="sortable-list space-y-0 flex-1 min-h-[20px]" data-widget-id="{{ widget.id }}">
                {% for link in widget.links.all %}
                    {% include "partials/link_item.html" %}
                {% endfor %}
            </ul>

        {% elif widget.widget_type == 'note' %}

            <textarea
                name="content"
                class="w-full h-64 bg-gray-900 text-gray-300 p-3 rounded border border-gray-700 focus:border-blue-500 focus:outline-none resize-none text-sm font-mono leading-relaxed"
                placeholder="Ã‰crivez vos notes ici..."
                hx-post="{% url 'save_note' widget.id %}"
                hx-trigger="keyup changed delay:500ms, blur"
                hx-swap="none"
            >{{ widget.content|default_if_none:"" }}</textarea>

            <div class="text-right mt-1 h-4">
                <span id="save-status-{{ widget.id }}" class="text-xs text-gray-600 italic transition-opacity duration-500 opacity-0">SauvegardÃ©</span>
            </div>

            <script>
                document.body.addEventListener('htmx:afterRequest', function(evt) {
                    if(evt.detail.elt.name === 'content' && evt.detail.elt.closest('#widget-{{ widget.id }}')) {
                        let status = document.getElementById('save-status-{{ widget.id }}');
                        status.classList.remove('opacity-0');
                        setTimeout(() => status.classList.add('opacity-0'), 2000);
                    }
                });
            </script>

        {% elif widget.widget_type == 'command' %}

            <form id="form-{{ widget.id }}" action="{% url 'add_link' widget.id %}" method="POST" class="hidden mb-3 bg-gray-900 p-3 rounded border border-gray-600 absolute top-0 left-0 right-0 z-10 shadow-xl">
                {% csrf_token %}
                <input type="text" name="title" placeholder="Nom du bouton (ex: Update)" required class="w-full mb-2 bg-gray-800 text-white px-2 py-1 rounded border border-gray-700">
                <input type="text" name="url" placeholder="Commande (ex: sudo apt update)" required class="w-full mb-2 bg-gray-800 text-white px-2 py-1 rounded border border-gray-700 font-mono text-xs">
                <button type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white py-1 rounded text-sm">CrÃ©er le bouton</button>
            </form>

            <div class="grid grid-cols-2 gap-2 overflow-y-auto p-1 max-h-64 custom-scrollbar">
                {% for link in widget.links.all %}
                <div class="relative group/cmd">
                    <button hx-get="{% url 'run_command' link.id %}"
                            hx-swap="none"
                            class="w-full bg-gray-700 hover:bg-blue-600 text-white p-2 rounded shadow border border-gray-600 flex flex-col items-center justify-center transition-all active:scale-95 h-16">
                        <span class="font-bold text-xs text-center leading-tight">{{ link.title }}</span>
                        <span class="text-[9px] text-gray-400 mt-1 font-mono truncate max-w-full opacity-60 w-full text-center">
                            >_ {{ link.url|truncatechars:12 }}
                        </span>
                    </button>

                    <div class="absolute top-0 right-0 flex space-x-1 opacity-0 group-hover/cmd:opacity-100 transition-opacity bg-gray-900/80 rounded px-1">
                         <button onclick="confirmDeleteLink('{{ link.id }}')" class="text-gray-300 hover:text-red-500 text-xs p-1 font-bold">âœ•</button>
                    </div>
                </div>
                {% endfor %}
            </div>

        {% endif %}

    </div>

</div>