<!--
    Ce fichier est le template principal et unique du tableau de bord personnel.
    Il est rendu par Django et contient toute la structure de l'interface.

    FONCTIONNEMENT :
    - Django : G√®re le rendu initial de la page, l'affichage des donn√©es (pages, widgets, liens)
      et traite les requ√™tes POST pour les modifications de la base de donn√©es.
    - HTMX : Utilis√© pour rendre l'application dynamique sans rechargement de page.
      Les actions comme l'ajout, la suppression ou la modification d'√©l√©ments
      se font via des requ√™tes AJAX d√©clench√©es par des attributs `hx-*`.
    - Tailwind CSS : Framework CSS utilis√© pour styliser l'ensemble de l'application
      avec une approche "utility-first". Le mode sombre (`dark`) est activ√© par d√©faut.
    - SortableJS : Biblioth√®que JavaScript qui permet de r√©organiser les √©l√©ments
      (liens, widgets, onglets) par glisser-d√©poser (Drag & Drop).
    - JavaScript Vanilla : Utilis√© pour la gestion des modales, des menus contextuels,
      de l'horloge, de la m√©t√©o, du calendrier et du "Mode Zen".

    STRUCTURE :
    1.  HEAD : Importation des librairies (Tailwind, HTMX, SortableJS) et styles CSS.
    2.  NAVIGATION PRINCIPALE : Barre sup√©rieure affichant les onglets (Pages) et les boutons de gestion.
    3.  BARRE DE RECHERCHE : Formulaire de recherche Google et bouton d'ajout de cat√©gorie.
    4.  CONTENU PRINCIPAL :
        - Affiche une grille de "widgets" (cat√©gories) pour la page active.
        - G√®re le cas sp√©cial de la page "Infos" pour afficher des widgets syst√®me (m√©t√©o, horloge, etc.).
        - Chaque widget est rendu via une inclusion du template partiel `partials/widget.html`.
    5.  MENUS CONTEXTUELS : Menus cach√©s qui apparaissent au clic droit sur un lien ou un widget.
    6.  MODALES : Fen√™tres pop-up pour les actions de cr√©ation, renommage et suppression.
    7.  BOUTONS FLOTTANTS : "Mode Zen" et "Backup".
    8.  SCRIPTS : Contient toute la logique c√¥t√© client (Drag & Drop, gestion des modales, horloge, etc.).
-->
{% load static %}
<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Perso</title>

    <!-- Importation des librairies JS -->
    <script src="{% static 'js/tailwind.js' %}"></script>
    <script src="{% static 'js/htmx.js' %}"></script>
    <script src="{% static 'js/sortable.js' %}"></script>

    <!-- Configuration de Tailwind CSS en JavaScript -->
    <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            gray: {
                                900: '#111827',
                                800: '#1f2937',
                                700: '#374151',
                            }
                        }
                    }
                }
            }
    </script>

    <!-- Styles CSS additionnels -->
    <style>
        #context-menu { display: none; position: absolute; z-index: 50; }
        .sortable-ghost { opacity: 0.4; background-color: #4B5563; }

        /* --- MODE ZEN --- */
        /* Ces classes masquent les √©l√©ments d'interface quand le body a la classe .zen-mode */
        body.zen-mode #main-nav { display: none !important; }
        body.zen-mode #search-container { display: none !important; }
        body.zen-mode .main-content { padding-top: 2rem !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen select-none"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'> <!-- Ajoute le token CSRF √† toutes les requ√™tes HTMX -->

<!-- =================================== -->
<!-- NAVIGATION PRINCIPALE (ONGLETS/PAGES) -->
<!-- =================================== -->
<nav id="main-nav" class="flex items-center space-x-2 p-3 bg-black border-b border-gray-800 overflow-x-auto">
    <div class="font-bold text-xl mr-4 text-white">‚â°</div>

    <!-- Boucle sur les pages pour afficher les onglets -->
    {% for page in pages %}
            <a href="{% url 'index' page.slug %}"
               data-id="{{ page.id }}"
               class="px-4 py-2 rounded transition-colors duration-200 whitespace-nowrap cursor-move
               {% if page == active_page %}bg-blue-600 text-white font-bold shadow-md{% else %}bg-gray-800 hover:bg-gray-700 text-gray-300{% endif %}">
                {{ page.name }}
            </a>
        {% endfor %}

    <!-- Boutons de gestion des pages -->
    <button onclick="toggleModal('modal-add-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-green-600 text-gray-400 hover:text-white font-bold transition-colors"
            title="Nouvelle page">
        +
    </button>

    {% if active_page %}
    <div class="h-6 w-px bg-gray-700 mx-2"></div>

    <button onclick="toggleModal('modal-rename-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-yellow-600 text-gray-400 hover:text-white transition-colors"
            title="Renommer la page active">
        ‚úé
    </button>

    <button onclick="toggleModal('modal-delete-page')"
            class="px-3 py-2 rounded bg-gray-800 hover:bg-red-600 text-gray-400 hover:text-white transition-colors"
            title="Supprimer la page active">
        üóë
    </button>
    {% endif %}
</nav>

<!-- ======================-->
<!-- BARRE DE RECHERCHE    -->
<!-- ======================-->
<div id="search-container" class="flex justify-center items-center py-8 px-4 gap-4">
    <!-- Formulaire de recherche Google -->
    <form action="https://www.google.com/search" method="GET" target="_blank"
          class="w-full max-w-2xl relative group">
        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>

        <input type="text"
       id="search-input"
       name="q"
       placeholder="Rechercher (Tapez pour filtrer, Entr√©e pour Google)..."
       autofocus
       onkeyup="liveSearch()"
       class="w-full bg-gray-800 text-white text-lg border border-gray-700 rounded-full py-3 pl-12 pr-4 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all placeholder-gray-500">

        <div class="absolute inset-0 rounded-full bg-blue-500 opacity-0 group-focus-within:opacity-20 blur-md transition-opacity -z-10"></div>
    </form>

    {% if active_page %}
    <!-- Bouton pour ajouter une nouvelle cat√©gorie (widget) √† la page active -->
    <button onclick="toggleModal('modal-add-widget')"
            class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-full shadow-lg flex items-center font-bold transition-colors whitespace-nowrap"
            title="Ajouter une cat√©gorie √† cette page">
        <span class="text-xl mr-2 leading-none">+</span> Cat√©gorie
    </button>
    {% endif %}
</div>

<!-- =================================== -->
<!-- CONTENU PRINCIPAL (GRILLE DE WIDGETS) -->
<!-- =================================== -->
<div class="p-6 main-content">
    {% if active_page %}

        <!-- Grille responsive qui contient tous les widgets -->
        <div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            <!-- Condition sp√©ciale : si la page s'appelle 'infos', on affiche les widgets syst√®me -->
            {% if active_page.slug == 'infos' %}
                <!-- WIDGET M√âT√âO -->
                <div class="col-span-1 md:col-span-2 bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 h-48 flex flex-col justify-between relative overflow-hidden">
                    <!-- ... Contenu du widget m√©t√©o ... -->
                </div>

                <!-- WIDGET HORLOGE/DATE -->
                <div class="col-span-1 md:col-span-2 bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-700 h-48 flex flex-col justify-center items-center">
                    <!-- ... Contenu du widget horloge ... -->
                </div>

                <!-- WIDGET MONITEUR SYST√àME (charg√© avec HTMX) -->
                <div class="col-span-1 md:col-span-1 bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-700 h-52 flex flex-col justify-center"
                     hx-get="{% url 'system_monitor' %}"
                     hx-trigger="load, every 8s">
                    <div class="text-center text-gray-500 text-xs animate-pulse">Chargement sys...</div>
                </div>

                <!-- WIDGET MARCH√âS FINANCIERS (via TradingView) -->
                <div class="col-span-1 md:col-span-2 bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-700 h-96">
                    <!-- ... Contenu du widget march√©s ... -->
                </div>

                <!-- WIDGET CALENDRIER -->
                <div class="col-span-1 md:col-span-2 bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 h-96 flex flex-col">
                    <!-- ... Contenu du widget calendrier ... -->
                </div>
           {% endif %}

            <!-- Boucle pour afficher les widgets cr√©√©s par l'utilisateur -->
            {% for widget in active_page.widgets.all %}
                {% include "partials/widget.html" %}
            {% endfor %}
        </div>

    {% else %}
        <!-- Message affich√© si aucune page n'est configur√©e -->
        <div class="text-center text-gray-500 mt-10">Aucune page configur√©e. Lancez la commande seed_db !</div>
    {% endif %}
</div>

<!-- =================================== -->
<!-- MENUS CONTEXTUELS (CLIC DROIT)      -->
<!-- =================================== -->

<!-- Menu pour les liens -->
<div id="context-menu" class="bg-gray-800 border border-gray-600 text-gray-200 rounded shadow-xl w-56 py-1 text-sm">
    <!-- ... Options du menu contextuel pour les liens ... -->
</div>

<!-- Menu pour les widgets (cat√©gories) -->
<div id="widget-context-menu" class="bg-gray-800 border border-gray-600 text-gray-200 rounded shadow-2xl w-56 py-1 text-sm fixed z-50 hidden">
    <!-- ... Options du menu contextuel pour les widgets ... -->
</div>

<!-- =================================== -->
<!-- MODALES (FEN√äTRES POP-UP)           -->
<!-- =================================== -->

<!-- Modale : Ajouter une page -->
<div id="modal-add-page" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
    <!-- ... Formulaire d'ajout de page ... -->
</div>

{% if active_page %}
    <!-- Modale : Renommer la page -->
    <div id="modal-rename-page" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <!-- ... Formulaire de renommage de page ... -->
    </div>

    <!-- Modale : Supprimer la page -->
    <div id="modal-delete-page" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <!-- ... Confirmation de suppression de page ... -->
    </div>

    <!-- Modale : Ajouter une cat√©gorie (widget) -->
    <div id="modal-add-widget" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <!-- ... Formulaire d'ajout de widget ... -->
    </div>

    <!-- Modale : Supprimer un widget -->
    <div id="modal-delete-widget" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <!-- ... Confirmation de suppression de widget ... -->
    </div>

    <!-- Modale : Supprimer un lien -->
    <div id="modal-delete-link" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm">
        <!-- ... Confirmation de suppression de lien ... -->
    </div>
{% endif %}

<!-- =================================== -->
<!-- BOUTONS FLOTTANTS                   -->
<!-- =================================== -->

<!-- Bouton pour activer/d√©sactiver le "Mode Zen" -->
<button id="zen-toggle-btn"
        onclick="toggleZenMode()"
        class="fixed bottom-6 right-6 z-50 bg-gray-800 hover:bg-blue-600 text-gray-400 hover:text-white p-3 rounded-full shadow-2xl border border-gray-600 transition-all duration-300 opacity-50 hover:opacity-100"
        title="Mode Zen (Masquer l'interface)">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
    </svg>
</button>

<!-- Bouton pour t√©l√©charger la sauvegarde -->
<a href="{% url 'download_backup' %}"
   class="fixed bottom-20 right-6 z-50 bg-gray-800 hover:bg-green-600 text-gray-400 hover:text-white p-3 rounded-full shadow-2xl border border-gray-600 transition-all duration-300 opacity-50 hover:opacity-100"
   title="T√©l√©charger une sauvegarde (.zip)">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    </svg>
</a>

<!-- =================================== -->
<!-- SCRIPTS JAVASCRIPT                  -->
<!-- =================================== -->
<script>
    // --- GESTION DES MENUS CONTEXTUELS ---
    // ... (code pour afficher/cacher les menus au clic droit et mettre √† jour leurs actions)

    // --- GESTION DES MODALES (POP-UP) ---
    function toggleModal(modalId) {
        // ... (code pour afficher/cacher les modales et g√©rer le focus)
    }
    // Fermeture des modales avec la touche "Echap"
    document.addEventListener('keydown', function(event) { /* ... */ });

    // --- PR√âPARATION DES CONFIRMATIONS DE SUPPRESSION ---
    // Injecte le bon ID dans le bouton de confirmation avant d'afficher la modale
    function confirmDeleteWidget(widgetId) { /* ... */ }
    function confirmDeleteLink(linkId) { /* ... */ }

    // --- DRAG & DROP AVEC SORTABLE.JS ---

    // Initialisation pour les LIENS √† l'int√©rieur de chaque widget
    document.querySelectorAll('.sortable-list').forEach(function(list) {
        new Sortable(list, {
            group: 'shared', // Permet de d√©placer les liens entre les listes
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                // ... (code qui envoie l'ordre des liens au serveur via fetch API)
            }
        });
    });

    // Initialisation pour les WIDGETS (cat√©gories) dans la grille principale
    var widgetGrid = document.getElementById('widget-grid');
    if (widgetGrid) {
        new Sortable(widgetGrid, {
            animation: 150,
            handle: '.widget-handle', // Le glisser-d√©poser ne s'active que sur l'en-t√™te du widget
            ghostClass: 'bg-gray-700',
            onEnd: function (evt) {
                // ... (code qui envoie le nouvel ordre des widgets au serveur via fetch API)
            }
        });
    }

    // Initialisation pour les PAGES (onglets) dans la barre de navigation
    var navContainer = document.getElementById('main-nav');
    if (navContainer) {
        new Sortable(navContainer, {
            animation: 150,
            draggable: 'a', // Seuls les liens <a> sont d√©pla√ßables
            ghostClass: 'bg-gray-600',
            onEnd: function (evt) {
                // ... (code qui envoie le nouvel ordre des pages au serveur via fetch API)
            }
        });
    }

    // --- LOGIQUE DES WIDGETS SP√âCIAUX (PAGE "INFOS") ---

    // Horloge digitale
    function updateClock() { /* ... */ }
    if(document.getElementById('clock-display')) { setInterval(updateClock, 1000); updateClock(); }

    // M√©t√©o (via API Open-Meteo)
    async function fetchWeather() { /* ... */ }
    fetchWeather();
    setInterval(fetchWeather, 1800000); // Rafra√Æchissement toutes les 30 minutes

    // Calendrier
    (function() { /* ... (code qui g√©n√®re le calendrier du mois courant) ... */ })();


    // --- FONCTIONNALIT√âS DIVERSES ---

    // Mode Zen (masque/affiche l'interface)
    function toggleZenMode() { /* ... */ }
    // Applique le mode Zen au chargement si la pr√©f√©rence est sauvegard√©e
    document.addEventListener('DOMContentLoaded', function() { /* ... */ });

    // Recherche instantan√©e (filtre les widgets et les liens)
    function liveSearch() { /* ... */ }

    // Ouvre tous les liens d'un widget dans de nouveaux onglets
    function openAllLinks(widgetId) { /* ... */ }

</script>

</body>
</html>