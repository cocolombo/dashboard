<script>
   // --- GESTION DES MENUS CONTEXTUELS ---
    // ... (code pour afficher/cacher les menus au clic droit et mettr
    const widgetMenu = document.getElementById('widget-context-menu');

    function showWidgetMenu(e, widgetId) {
        e.preventDefault();
        e.stopPropagation();

        widgetMenu.style.left = e.clientX + 'px';
        widgetMenu.style.top = e.clientY + 'px';
        widgetMenu.classList.remove('hidden');

        document.querySelectorAll('.widget-move-form').forEach(form => {
            let baseAction = form.getAttribute('action');
            let newAction = baseAction.replace(/\/\d+\/$/, '/' + widgetId + '/');
            form.setAttribute('action', newAction);
        });
    }

    document.addEventListener('click', function(e) {
        if (widgetMenu && !widgetMenu.contains(e.target)) {
            widgetMenu.classList.add('hidden');
        }
        const linkMenu = document.getElementById('context-menu');
        if (linkMenu) linkMenu.style.display = 'none';
    });

    // --- GESTION DES MODALES (Popup) ---
    function toggleModal(modalId) {
       // ... (code pour afficher/cacher les modales et gÃ©rer le focus)
        const modal = document.getElementById(modalId);
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            const input = modal.querySelector('input');
            if(input) setTimeout(() => input.focus(), 100);
        } else {
            modal.classList.add('hidden');
        }
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            document.querySelectorAll('[id^="modal-"]').forEach(modal => modal.classList.add('hidden'));
            if(widgetMenu) widgetMenu.classList.add('hidden');
        }
    });

    // --- PRÃ‰PARATION SUPPRESSION ---
    function confirmDeleteWidget(widgetId) {
        const confirmBtn = document.getElementById('btn-confirm-delete-widget');
        confirmBtn.href = "/widget/delete/" + widgetId + "/";
        toggleModal('modal-delete-widget');
    }

    function confirmDeleteLink(linkId) {
        const confirmBtn = document.getElementById('btn-confirm-delete-link');
        confirmBtn.href = "/link/delete/" + linkId + "/";
        toggleModal('modal-delete-link');
    }

    // --- AFFICHAGE FORMULAIRE LIEN ---
    function toggleForm(formId) {
        const form = document.getElementById(formId);
        if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
            form.querySelector('input').focus();
        } else {
            form.classList.add('hidden');
        }
    }

    // --- DRAG & DROP : LIENS ---
    document.querySelectorAll('.sortable-list').forEach(function(list) {
        new Sortable(list, {
            group: 'shared',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                var targetList = evt.to;
                var widgetId = targetList.getAttribute('data-widget-id');
                var listItems = targetList.querySelectorAll('li');
                var linkIds = Array.from(listItems).map(li => li.getAttribute('data-id'));

                var formData = new FormData();
                formData.append('widget_id', widgetId);
                linkIds.forEach(id => formData.append('link', id));

                fetch('/api/update-order/', { method: 'POST', body: formData });
            }
        });
    });

    // --- DRAG & DROP : CATÃ‰GORIES (Widgets) ---
    var widgetGrid = document.getElementById('widget-grid');
    if (widgetGrid) {
        new Sortable(widgetGrid, {
            animation: 150,
            handle: '.widget-handle',
            ghostClass: 'bg-gray-700',
            onEnd: function (evt) {
                var listItems = widgetGrid.children;
                var widgetIds = Array.from(listItems).map(div => div.getAttribute('data-id'));

                var formData = new FormData();
                widgetIds.forEach(id => formData.append('widget', id));

                fetch('/api/update-widget-order/', { method: 'POST', body: formData });
            }
        });
    }

    // --- DRAG & DROP : PAGES (Onglets) ---
    var navContainer = document.getElementById('main-nav');
    if (navContainer) {
        new Sortable(navContainer, {
            animation: 150,
            draggable: 'a', // On ne dÃ©place que les liens (pas les boutons + / edit)
            ghostClass: 'bg-gray-600',
            onEnd: function (evt) {
                var itemEl = evt.item;
                var listItems = navContainer.querySelectorAll('a[data-id]');
                var pageIds = Array.from(listItems).map(el => el.getAttribute('data-id'));

                var formData = new FormData();
                pageIds.forEach(id => formData.append('page', id));

                fetch('/api/update-page-order/', { method: 'POST', body: formData });
            }
        });
    }

    // --- MENU CONTEXTUEL : LIENS (Clic Droit) ---
    const linkMenu = document.getElementById('context-menu');
    function showContextMenu(e, linkId) {
        e.preventDefault();
        linkMenu.style.left = e.pageX + 'px';
        linkMenu.style.top = e.pageY + 'px';
        linkMenu.style.display = 'block';

        document.querySelectorAll('form[hx-post]').forEach(form => {
            let url = form.getAttribute('hx-post').replace(/\d+$/, linkId);
            form.setAttribute('hx-post', url);
            if (typeof htmx !== 'undefined') htmx.process(form);
        });
    }

    // --- HORLOGE DIGITALE ---
    function updateClock() {
        const clockEl = document.getElementById('clock-display');
        const dateEl = document.getElementById('date-display');
        if (!clockEl) return;

        const now = new Date();
        clockEl.textContent = now.toLocaleTimeString('fr-CA', { hour12: false });
        dateEl.textContent = now.toLocaleDateString('fr-CA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    if(document.getElementById('clock-display')) {
        setInterval(updateClock, 1000);
        updateClock();
    }


    // Configuration Open-Meteo pour MontrÃ©al
    const API_URL = "https://api.open-meteo.com/v1/forecast?latitude=45.5017&longitude=-73.5673&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=America%2FToronto&forecast_days=4";

    function getWeatherIcon(code) {
        const icons = {
            0: 'â˜€ï¸', 1: 'ğŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸', 45: 'ğŸŒ«ï¸', 48: 'ğŸŒ«ï¸',
            51: 'ğŸŒ¦ï¸', 53: 'ğŸŒ¦ï¸', 55: 'ğŸŒ§ï¸', 61: 'ğŸŒ§ï¸', 63: 'ğŸŒ§ï¸', 65: 'â›ˆï¸',
            71: 'ğŸŒ¨ï¸', 73: 'ğŸŒ¨ï¸', 75: 'â„ï¸', 80: 'ğŸŒ¦ï¸', 81: 'ğŸŒ§ï¸', 82: 'â›ˆï¸', 95: 'â›ˆï¸',
        };
        return icons[code] || 'â“';
    }

    function getDayName(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', { weekday: 'short' });
    }

    async function fetchWeather() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();

            document.getElementById('current-temp').innerText = Math.round(data.current.temperature_2m) + "Â°C";
            document.getElementById('current-desc').innerText = "Code mÃ©tÃ©o: " + data.current.weather_code;

            const grid = document.getElementById('forecast-grid');
            grid.innerHTML = '';

            for (let i = 1; i < 4; i++) {
                const dayName = getDayName(data.daily.time[i]);
                const maxTemp = Math.round(data.daily.temperature_2m_max[i]);
                const minTemp = Math.round(data.daily.temperature_2m_min[i]);
                const icon = getWeatherIcon(data.daily.weather_code[i]);

                const html = `
                    <div class="flex flex-col items-center p-2 rounded hover:bg-gray-700/50 transition-colors">
                        <span class="text-gray-400 text-xs uppercase font-bold mb-1">${dayName}.</span>
                        <span class="text-2xl mb-1">${icon}</span>
                        <div class="text-sm font-bold text-white">
                            ${maxTemp}Â° <span class="text-gray-500 text-xs font-normal">| ${minTemp}Â°</span>
                        </div>
                    </div>
                `;
                grid.innerHTML += html;
            }

        } catch (error) {
            console.error("Erreur MÃ©tÃ©o:", error);
            if(document.getElementById('current-desc')) document.getElementById('current-desc').innerText = "Erreur";
        }
    }

    fetchWeather();
    setInterval(fetchWeather, 1800000);


    // --- MODE ZEN ---
    function toggleZenMode() {
        const body = document.body;
        body.classList.toggle('zen-mode');
        const isZen = body.classList.contains('zen-mode');
        localStorage.setItem('zenMode', isZen);
        const btn = document.querySelector('#zen-toggle-btn svg path');
        if (isZen) {
            btn.setAttribute('d', 'M6 18L18 6M6 6l12 12');
        } else {
            btn.setAttribute('d', 'M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('zenMode') === 'true') {
            toggleZenMode();
        }
    });

    // --- CALENDRIER ---
    (function() {
        const date = new Date();
        const currYear = date.getFullYear();
        const currMonth = date.getMonth();
        const monthNames = ["Janvier", "FÃ©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "AoÃ»t", "Septembre", "Octobre", "Novembre", "DÃ©cembre"];

        const title = document.getElementById('cal-month-year');
        const grid = document.getElementById('cal-days');

        if(title && grid) {
            title.innerText = `${monthNames[currMonth]} ${currYear}`;
            let firstDay = new Date(currYear, currMonth, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1;
            const lastDate = new Date(currYear, currMonth + 1, 0).getDate();

            let html = "";
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="p-1"></div>`;
            }
            for (let i = 1; i <= lastDate; i++) {
                let isToday = (i === date.getDate() && currMonth === new Date().getMonth() && currYear === new Date().getFullYear());
                let classes = isToday
                    ? "bg-blue-600 text-white font-bold shadow-md transform scale-110 rounded-full w-8 h-8 flex items-center justify-center mx-auto"
                    : "text-gray-300 hover:bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center mx-auto transition-colors cursor-default";
                html += `<div class="${classes}">${i}</div>`;
            }
            grid.innerHTML = html;
        }
    })();

    // --- OPEN ALL LINKS ---
    function openAllLinks(widgetId) {
        const widgetContainer = document.querySelector(`div[data-id="${widgetId}"]`);
        if (!widgetContainer) return;

        const links = widgetContainer.querySelectorAll('ul.sortable-list a');

        if (links.length > 5) {
            if (!confirm(`Voulez-vous ouvrir ${links.length} onglets ?`)) return;
        }

        Array.from(links).forEach((link, index) => {
            if (link.href) {
                setTimeout(() => {
                    window.open(link.href, '_blank');
                }, 150 * index);
            }
        });
    }

    // --- LIVE SEARCH ---
    function liveSearch() {
        let input = document.getElementById('search-input');
        let filter = input.value.toLowerCase();
        let widgets = document.querySelectorAll('.group\\/widget');

        widgets.forEach(function(widget) {
            let widgetMatch = false;

            // Check Title
            let titleEl = widget.querySelector('h3, h2, .font-bold');
            if (titleEl && titleEl.innerText.toLowerCase().includes(filter)) {
                widgetMatch = true;
            }

            // Check Links
            let links = widget.querySelectorAll('li');
            let hasVisibleLink = false;

            links.forEach(function(link) {
                let text = link.innerText.toLowerCase();
                if (text.includes(filter) || widgetMatch) {
                    link.style.display = "";
                    hasVisibleLink = true;
                } else {
                    link.style.display = "none";
                }
            });

            // Check Notes
            let note = widget.querySelector('textarea');
            if (note) {
                let noteText = note.value.toLowerCase();
                if (noteText.includes(filter) || widgetMatch) {
                    hasVisibleLink = true;
                }
            }

            if (widgetMatch || hasVisibleLink || filter === "") {
                widget.style.display = "";
            } else {
                widget.style.display = "none";
            }
        });
    }

    // --- REINIT SORTABLE APRES HTMX LOAD ---
    htmx.onLoad(function(content) {
        var sortables = content.querySelectorAll('.sortable-list');
        sortables.forEach(function(list) {
             new Sortable(list, {
                group: 'shared',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    var targetList = evt.to;
                    var widgetId = targetList.getAttribute('data-widget-id');
                    var listItems = targetList.querySelectorAll('li');
                    var linkIds = Array.from(listItems).map(li => li.getAttribute('data-id'));
                    var formData = new FormData();
                    formData.append('widget_id', widgetId);
                    linkIds.forEach(id => formData.append('link', id));
                    fetch('/api/update-order/', { method: 'POST', body: formData });
                }
            });
        });
    });

</script>
